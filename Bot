from telegram.ext import Application, CommandHandler, MessageHandler, filters as Filters, CallbackQueryHandler, CallbackContext
from telegram import Update, ForceReply, InlineKeyboardButton, InlineKeyboardMarkup
from typing import Union

TOKEN = '6105377507:AAHzMBoQx1sWo2g8ICwxQRJSKpCVlfSUYtc'

pizza_dict = {
    'Cheese': {'name': ' ðŸ§€ Ð¡Ñ‹Ñ€Ð½Ð°Ñ', 'price': 400},
    'Carbonara': {'name': ' ðŸ¥© ÐšÐ°Ñ€Ð±Ð¾Ð½Ð°Ñ€Ð°', 'price': 500},
    'Dodo': {'name': ' ðŸ¥“ Ð”Ð¾Ð´Ð¾', 'price': 650},
    'Homelike': {'name': ' ðŸ² Ð”Ð¾Ð¼Ð°ÑˆÐ½ÑÑ', 'price': 350},
}

size_dict = {
    'small': {'name': 'ðŸ“ 30 ÑÐ¼', 'price_multiplier': 1},
    'medium': {'name': 'ðŸ“ 40 ÑÐ¼', 'price_multiplier': 1.5},
    'large': {'name': 'ðŸ“ 50 ÑÐ¼', 'price_multiplier': 2},
}

async def create_pizza_keyboard(buttons_per_row=2):
    keyboard = []
    row = []

    for pizza_key, pizza_info in pizza_dict.items():
        row.append(
            InlineKeyboardButton(pizza_info['name'], callback_data=f'pizza_{pizza_key}')
        )

        if len(row) == buttons_per_row:
            keyboard.append(row)
            row = []

    if row:
        keyboard.append(row)

    return InlineKeyboardMarkup(keyboard)

async def create_size_keyboard(buttons_per_row=2):
    keyboard = []
    row = []

    for size_key, size_info in size_dict.items():
        row.append(
            InlineKeyboardButton(size_info['name'], callback_data=f'size_{size_key}')
        )

        if len(row) == buttons_per_row:
            keyboard.append(row)
            row = []

    if row:
        keyboard.append(row)

    return InlineKeyboardMarkup(keyboard)

async def start(update: Update, context: Union[CallbackContext, None]) -> None:
    user = update.effective_user
    await update.message.reply_markdown_v2(
        fr'Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ Ð´Ð¾Ñ€Ð¾Ð³Ð¾Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚ðŸ¤š , {user.mention_markdown_v2()}',
        reply_markup=ForceReply(selective=True),
    )

async def echo(update: Update, context: Union[CallbackContext, None]) -> None:
    if context.user_data.get('awaiting_address', False):
        await address(update, context)
    else:
        reply_markup = await create_pizza_keyboard()
        await update.message.reply_text(text='Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¸Ñ†Ñ†Ñƒ ðŸ‘‡:', reply_markup=reply_markup)

async def button(update: Update, context: Union[CallbackContext, None]) -> None:
    query = update.callback_query
    data_parts = query.data.split('_')

    if data_parts[0] == 'pizza':
        context.user_data['selected_pizza'] = data_parts[1]
        reply_markup = await create_size_keyboard()
        reply_text = 'ÐšÐ°ÐºÐ¾Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð¸Ñ†Ñ†Ñ‹ Ð²Ð°Ñ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚ ðŸ˜:'
    elif data_parts[0] == 'size':
        context.user_data['selected_size'] = data_parts[1]
        reply_text = 'Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð°Ð´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ âœ:'
        reply_markup = ForceReply(selective=True)
        await context.bot.send_message(chat_id=update.effective_chat.id, text=reply_text, reply_markup=reply_markup)
        await query.answer()
        context.user_data['awaiting_address'] = True
        return
    else:
        reply_text = 'ðŸ˜Ÿ Ð§Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº, Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð·Ð°ÐºÐ°Ð·.'
        reply_markup = None
    
    await query.edit_message_text(text=reply_text, reply_markup=reply_markup)
    await query.answer()

async def address(update: Update, context: Union[CallbackContext, None]) -> None:
    address = update.message.text
    selected_pizza = pizza_dict[context.user_data['selected_pizza']]
    selected_size = size_dict[context.user_data['selected_size']]

    price = selected_pizza['price'] * selected_size['price_multiplier']
    reply_text = f'â¤ Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð·Ð°ÐºÐ°Ð·.\nðŸ¤¤ ÐŸÐ¸Ñ†Ñ†Ð°:{selected_pizza["name"]},\nðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€:{selected_size["name"]}\nðŸ“« ÐÐ´Ñ€ÐµÑ: {address}\nðŸ’° Ð¦ÐµÐ½Ð°: {price} Ñ€ÑƒÐ±.'
    context.user_data['awaiting_address'] = False

    await update.message.reply_text(text=reply_text)

def main() -> None:
    application = Application.builder().token(TOKEN).build()

    application.add_handler(CommandHandler('start', start))
    application.add_handler(MessageHandler(Filters.TEXT & ~Filters.COMMAND, echo))
    application.add_handler(CallbackQueryHandler(button))
    application.add_handler(MessageHandler(Filters.REPLY & Filters.TEXT, address))

    application.run_polling()

if __name__ == '__main__':
    main()
